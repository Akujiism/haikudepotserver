% -----------
% Copyright 2013-2014, Andrew Lindesay
% Distributed under the terms of the MIT License.
% -----------

\section{Deployment}

This section outlines the approximate steps to deploy the web application-server.  The application-server build process produces a  `stand-alone' java program.  This build artifact is a packaged `jar' file that contains the \href{http://tomcat.apache.org}{Tomcat} servlet container as well as the web application.  Upon launching, it will unbundle necessary parts and start-up listening on a socket for inbound HTTP requests.

\fcolorbox{red}{white}{\parbox{\textwidth}{\color{red} The default database installs a user with the nickname of `root' with a known password of `p4mphl3t'.  This password {\bf must} be changed before the system is made available over a network.}}

\fcolorbox{red}{white}{\parbox{\textwidth}{\color{red}The API-related HTTP traffic into the application server uses basic or token bearer authentication.  Either technique exposes authentication details in the request and response.  For this reason it is advised that HTTP traffic to and from the application server be transported as secure HTTP (https) in order to prevent a third party from reading the HTTP headers and extracting this information.}}

Please see \ref{prerequisites} for prerequisites required for running this software and \ref{buildandrelease} for information about obtaining a build product and possibly also creating a release version.  The build product that you will require for deployment can be found at;

\framebox{\tt haikudepotserver-webapp/target/haikudepotserver-webapp-1.2.3-war-exec.jar}

The leaf-name will vary depending on the release that is being build.  You should also refer to \ref{config} for details of the format and keys for the configuration file.  You will need to create a configuration file for your deployment.

To launch the binary with 256 megabytes of heap memory, issue a command similar to;

\begin{verbatim}
java \
 -Xmx512m \
 -Dfile.encoding=UTF-8 \
 -Duser.timezone=GMT0 \
 -Djava.awt.headless=true \
 -Dconfig.properties=file:///etc/haikudepotserver/config.properties \
 -jar haikudepotserver-webapp-1.2.3-war-exec.jar \
 -resetExtract \
 -extractDirectory /var/cache/haikudepotserver
\end{verbatim}

By default the logging will be streamed to stdout/stderr.  It is possible to configure this using a \href{http://logback.qos.ch/}{logback} logging configuration file.

There are a handful of other easily-accessed command line options which can be used to fine-tune the deployment.  These can be viewed by executing the binary as follows;

\begin{verbatim}
java \
 -jar haikudepotserver-webapp-1.2.3-war-exec.jar \
 -h
\end{verbatim}

\subsection{Setting Up Repositories}
\label{settinguprepositories}

The application server will pull ``.hpkr'' files from remote repositories that contain information about the packages at that repository.  Authenticated as root, it is possible to use the ``more'' link at the top of the home page to get to the repositories, to add a repository and to trigger the import of a repository.  There also exists an HTTP GET invocation (see \ref{api-importrepositorydata}) that can be made to trigger the import of a repository from another system\footnote{Such as the HPKR assembly process}.

\subsection{Maintenance Tasks}

Some maintenance tasks are scheduled.  These tasks are scheduled from outside the application server in order to simplify a multi-instance deployment topology.  A simple approach to this is to schedule using the cron tool.  This would require a ``crontab'' entry such as;

 \framebox{\tt 14 * * * * curl "http://localhost:8080/maintenance/mediumterm"}

 The host and port should be adjusted to suit your deployment environment.

\subsection{Accessing the Web Environment}

Once running, the web environment will be accessible from;

\framebox{\tt http://localhost:8080/}

\subsection{Deployment with RPM}

The build system, when executed on a linux host, will produce an RPM deployment file containing the resources necessary for the system to be installed onto an RPM-based linux system.  This RPM does not have any dependencies and so both java and Postgres database server will need to be installed before the application server can be successfully started --- see \ref{prerequisites}.  The RPM is built under the {\tt haikudepotserver-rpm} module and can be found at this path from that module;

\framebox{\tt ../target/rpm/haikudepotserver/RPMS/noarch/}

\subsubsection{Installing}

The RPM can be installed with the following command making an obvious reference to the RPM file.

\framebox{\tt rpm -ivh haikudepotserver-1.0.2.rpm}

The RPM can be uninstalled with the following command;

\framebox{\tt rpm -e haikudepotserver}

It would be prudent to first ensure that the application server is not running before uninstalling it.

\subsubsection{File Locations}

The RPM will install files into the following locations;

\begin{tabular}{|l|l|}
\hline
{\tt /var/log/haikudepotserver/..} & Log files from the application server \\
{\tt /opt/haikudepotserver/..} & Application server binary resources \\
{\tt /var/cache/haikudepotserver/..} & Operational files for the application server \\
{\tt /etc/haikudepotserver/..} & Configuration files \\
{\tt /etc/logrotate.d/..} & Log rotation configuration \\
{\tt /etc/init.d/haikudepotserver} & Start and stop script \\
\hline
\end{tabular}

\subsubsection{Start and Stop}

The installed application server can be started with the following command, referencing the RPM file;

\framebox{\tt service haikudepotserver start}

The installed application server can be stopped with the following command;

\framebox{\tt service haikudepotserver stop}

\subsubsection{Automatic Startup and Shutdown}

The installed application server can be configured to startup automatically using the following command;

\framebox{\tt chkconfig --add haikudepotserver}

The installed application can later be prevented from automatic startup using the following command;

\framebox{\tt chkconfig --del haikudepotserver}
